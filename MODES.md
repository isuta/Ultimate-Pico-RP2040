# モード一覧と操作方法

このドキュメントでは、システムの全てのモードとその操作方法、設定方法を説明します。

---

## 📋 目次

1. [モード一覧](#モード一覧)
2. [通常モード](#通常モード)
3. [セレクトモード](#セレクトモード)
4. [ワークショップモード](#ワークショップモード)
5. [コンソール専用モード](#コンソール専用モード)
6. [ボタン操作一覧](#ボタン操作一覧)
7. [設定方法](#設定方法)

---

## 🎯 モード一覧

| モード名 | 起動方法 | 用途 | 設定場所 |
|---------|---------|------|---------|
| **通常モード** | デフォルト（起動時） | ランダム再生、アイドル自動再生 | `config.py` |
| **セレクトモード** | 起動時に1秒以上長押し | シナリオを手動選択して再生 | ボタン操作 |
| **ワークショップモード** | `config.py`で設定 | 起動直後から連続自動再生 | `config.py` |
| **コンソール専用モード** | ボタン初期化失敗時 | 自動再生のみ（操作不可） | 自動 |

---

## 🎮 通常モード

### 概要
システムのデフォルトモード。ボタン操作でランダム再生、アイドル時には自動再生を行います。

### 表示
OLED: `Push the button`

### ボタン操作
- **短押し**（< 0.5秒）: ランダムシナリオを再生
- **長押し**（≥ 1秒）: セレクトモードに移行
- **再生中に短押し**: 再生を停止

### 自動再生動作
1. **アイドルタイムアウト**: 最後の操作から5分間（デフォルト）操作がない
2. **自動再生開始**: 60秒間隔（デフォルト）でランダムシナリオを再生

### 設定項目（config.py）

```python
# アイドル状態に移行するまでの無操作時間 (ms)
IDLE_TIMEOUT_MS = 300000  # 5分

# アイドル状態での自動再生間隔 (秒)
AUTO_PLAY_INTERVAL_SECONDS = 60  # 1分
```

### カスタマイズ例

#### アイドルタイムアウトを短縮
```python
IDLE_TIMEOUT_MS = 60000  # 1分に変更
```

#### 自動再生間隔を変更
```python
AUTO_PLAY_INTERVAL_SECONDS = 30  # 30秒ごとに再生
```

---

## 🔍 セレクトモード

### 概要
シナリオを手動で選択して実行するモード。デバッグやデモに最適。

### 起動方法
**通常モード**で1秒以上ボタンを長押し

### 表示
OLED: `Select Mode` + シナリオ名（例: `1`）

### ボタン操作
| 操作 | 動作 |
|------|------|
| **短押し1回** | 次のシナリオに移動 |
| **短押し2回連続** | 前のシナリオに移動 |
| **長押し**（≥ 1秒） | 選択中のシナリオを再生 |
| **再生中に短押し** | 再生を停止 |

### 選択可能なシナリオ
`scenarios.json`内の全てのシナリオが対象（ランダム再生対象外も含む）

### シナリオの並び順
`scenarios.json`での定義順

### 設定項目（config.py）

```python
# 短押しと判定する最大押下時間 (ms)
BUTTON_SHORT_PRESS_MS = 500

# 長押しと判定する最小押下時間 (ms)
BUTTON_LONG_PRESS_MS = 1000

# ダブルクリック判定の最大間隔 (ms)
BUTTON_DOUBLE_CLICK_INTERVAL_MS = 500
```

### カスタマイズ例

#### 長押し時間を短縮
```python
BUTTON_LONG_PRESS_MS = 700  # 0.7秒に短縮
```

#### ダブルクリックを検出しやすく
```python
BUTTON_DOUBLE_CLICK_INTERVAL_MS = 800  # 0.8秒まで許容
```

---

## 🎪 ワークショップモード

### 概要
起動直後から待ち時間なしでランダム再生を連続実行するモード。勉強会やデモ展示に最適。

### 起動方法
`config.py`で設定

### 表示
OLED: 通常モードと同じ

### 動作
1. システム起動
2. 即座にランダムシナリオを再生
3. 3秒待機（デフォルト）
4. 次のシナリオを再生（繰り返し）

### ボタン操作
通常モードと同じ（ランダム再生、長押しでセレクトモード）

### 設定方法（config.py）

```python
# ワークショップ/デモモード設定
WORKSHOP_MODE = True  # True: 有効、False: 無効

# ワークショップモードでのシナリオ間の待機時間 (秒)
WORKSHOP_MODE_INTERVAL_SECONDS = 3
```

### カスタマイズ例

#### ワークショップモードを有効化
```python
WORKSHOP_MODE = True
WORKSHOP_MODE_INTERVAL_SECONDS = 5  # 5秒間隔
```

#### 通常モードに戻す
```python
WORKSHOP_MODE = False
```

### ⚠️ 注意事項
- ランダム再生対象は**数字で始まるシナリオのみ**
- 例: `"1"`, `"2"`, `"901"` ✅  /  `"test"`, `"demo"` ❌

---

## 💻 コンソール専用モード

### 概要
ボタンが初期化失敗した場合に自動的に移行するフェイルセーフモード。

### 起動条件
- ボタンのGPIOピン初期化失敗
- ハードウェア接続不良

### 表示
```
=== Console-Only Mode ===
Running in console-only mode due to button initialization failure.
System will automatically start random playback after idle timeout.
Idle timeout: 300.0 seconds
Auto-play interval: 60.0 seconds
=========================
```

### 動作
- ボタン操作: 不可
- 自動再生: アイドルタイムアウト後に自動開始
- モード切替: 不可

### 復旧方法
1. システムを停止（Ctrl+C）
2. ボタン配線を確認
3. 再起動

---

## 🕹️ ボタン操作一覧

### 通常モード

| 操作 | 押下時間 | 動作 |
|------|---------|------|
| 短押し | < 0.5秒 | ランダムシナリオ再生 |
| 長押し | ≥ 1秒 | セレクトモードに移行 |
| 再生中に短押し | < 0.5秒 | 再生停止 |

### セレクトモード

| 操作 | 押下時間 | 動作 |
|------|---------|------|
| 短押し1回 | < 0.5秒 | 次のシナリオ |
| 短押し2回連続 | 各 < 0.5秒、間隔 < 0.5秒 | 前のシナリオ |
| 長押し | ≥ 1秒 | シナリオ再生 |
| 再生中に短押し | < 0.5秒 | 再生停止 |

### ボタン操作の流れ図

```
起動
 │
 ├─ 1秒以上長押し → セレクトモード
 │                    │
 │                    ├─ 短押し1回 → 次へ
 │                    ├─ 短押し2回 → 前へ
 │                    └─ 長押し → 再生
 │
 └─ 短押し → 通常モード
              │
              └─ ランダム再生
```

---

## ⚙️ 設定方法

### config.pyの場所

```
Ultimate-Pico-RP2040/
  └─ config.py
```

### 主要な設定項目

#### タイミング設定

```python
# ボタン操作の閾値設定 (ms)
BUTTON_SHORT_PRESS_MS = 500           # 短押しの最大時間
BUTTON_LONG_PRESS_MS = 1000           # 長押しの最小時間
BUTTON_DOUBLE_CLICK_INTERVAL_MS = 500 # ダブルクリック判定間隔

# システム / タイミング設定
MAIN_LOOP_POLLING_MS = 50             # メインループの間隔
IDLE_TIMEOUT_MS = 300000              # アイドル移行時間（5分）
AUTO_PLAY_INTERVAL_SECONDS = 60       # 自動再生間隔（1分）
```

#### ワークショップモード設定

```python
# ワークショップ/デモモード設定
WORKSHOP_MODE = False                     # True: 有効、False: 無効
WORKSHOP_MODE_INTERVAL_SECONDS = 3        # シナリオ間隔（秒）
```

#### メモリ管理設定

```python
# メモリ管理設定
GC_ON_SCENARIO_COMPLETE = True  # シナリオ完了時GC（推奨: True）
GC_INTERVAL = 0                 # 定期GC間隔（0=無効、推奨）
GC_MEMORY_LOGGING = False       # メモリログ出力（デバッグ用）
```

### 設定変更の手順

1. **config.pyを開く**
   ```
   任意のテキストエディタで編集
   ```

2. **設定値を変更**
   ```python
   WORKSHOP_MODE = True  # Falseから変更
   ```

3. **保存してマイコンに転送**
   ```
   Thonny等のIDEで保存 → マイコンに転送
   ```

4. **再起動**
   ```
   Ctrl+D または 電源再投入
   ```

---

## 🎨 カスタマイズ例

### 例1: デモ展示用設定

```python
# 起動直後から連続自動再生、短い間隔
WORKSHOP_MODE = True
WORKSHOP_MODE_INTERVAL_SECONDS = 2

# アイドルタイムアウトを短縮
IDLE_TIMEOUT_MS = 30000  # 30秒

# ボタン操作を簡単に
BUTTON_LONG_PRESS_MS = 700  # 0.7秒
```

### 例2: 通常使用（待機時間長め）

```python
# ワークショップモード無効
WORKSHOP_MODE = False

# 自動再生を遅く
IDLE_TIMEOUT_MS = 600000         # 10分
AUTO_PLAY_INTERVAL_SECONDS = 120 # 2分
```

### 例3: デバッグ用設定

```python
# ワークショップモード無効
WORKSHOP_MODE = False

# メモリ監視を有効化
GC_MEMORY_LOGGING = True

# アイドルタイムアウトを短縮（テスト用）
IDLE_TIMEOUT_MS = 10000  # 10秒
```

---

## 📚 関連ドキュメント

- **[README.md](./README.md)** - プロジェクト概要と基本操作
- **[CONFIGURATION.md](./CONFIGURATION.md)** - 詳細な設定ガイド
- **[SCENARIO_GUIDE.md](./SCENARIO_GUIDE.md)** - シナリオ作成方法
- **[ARCHITECTURE.md](./ARCHITECTURE.md)** - システム構造
- **[HARDWARE_NOTES.md](./HARDWARE_NOTES.md)** - ハードウェア接続

---

## 🔍 トラブルシューティング

### セレクトモードに入れない
- **原因**: 長押し時間が短い
- **対処**: 1秒以上しっかり押し続ける

### ワークショップモードが動作しない
- **原因**: シナリオ名が数字で始まっていない
- **対処**: `scenarios.json`でシナリオ名を`"1"`, `"2"`等に変更

### 自動再生が始まらない
- **原因**: アイドルタイムアウトに達していない
- **対処**: `IDLE_TIMEOUT_MS`を短くするか、時間経過を待つ

### コンソール専用モードから復帰しない
- **原因**: ボタンのハードウェア接続不良
- **対処**: GP18ピンの配線とプルダウン抵抗を確認
