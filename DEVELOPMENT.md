# 開発ガイドライン

このドキュメントは、Ultimate-Pico-RP2040プロジェクトの開発時に守るべきルールとチェックリストをまとめたものです。

---

## 🔄 コード修正時のドキュメント更新チェックリスト

コードを変更した際は、**必ず関連ドキュメントの更新も同時に実施**してください。

### ✅ 必須チェック項目

#### 1. **新機能追加・既存機能修正時**
- [ ] [README.md](./README.md) - 機能説明、コマンドリファレンス、使用例
- [ ] [ARCHITECTURE.md](./ARCHITECTURE.md) - システム構造、モジュール説明、データフロー
- [ ] [CHANGELOG.md](./CHANGELOG.md) - 変更履歴に日付とともに追記
- [ ] [HARDWARE_NOTES.md](./HARDWARE_NOTES.md) - ハードウェア接続、GPIO変更、技術仕様

#### 2. **新規モジュール追加時**
- [ ] [README.md](./README.md) - 「必要ファイル」リストに追加
- [ ] [ARCHITECTURE.md](./ARCHITECTURE.md) - モジュールの役割と主な関数を説明
- [ ] [config.py](./config.py) - 必要に応じて設定項目を追加

#### 3. **GPIO/ピン変更時**
- [ ] [config.py](./config.py) - GPIO使用状況一覧を更新（ファイル先頭のコメント）
- [ ] [HARDWARE_NOTES.md](./HARDWARE_NOTES.md) - GPIOピンアサイン表を更新

#### 4. **JSONコマンド形式変更時**
- [ ] [README.md](./README.md) - コマンドリファレンスを更新
- [ ] [ARCHITECTURE.md](./ARCHITECTURE.md) - コマンド解析フローを更新
- [ ] 既存の [scenarios.json](./scenarios.json) との互換性を確認

#### 5. **設定パラメータ変更時**
- [ ] [config.py](./config.py) - コメントで用途・単位・推奨値を明記
- [ ] [README.md](./README.md) - 必要に応じて設定セクションを更新

---

## 📝 ドキュメント更新の原則

### 原則1: **コードとドキュメントの同期**
- コード変更とドキュメント更新を**同一コミット**で実施
- 「後で更新する」は禁止 - すぐに乖離が発生します

### 原則2: **具体例を含める**
- 抽象的な説明だけでなく、コード例やコマンド例を記載
- ユーザーがコピー＆ペーストで使える形式を心がける

### 原則3: **技術詳細は適切な場所に**
- 概要・使い方 → [README.md](./README.md)
- システム構造・設計思想 → [ARCHITECTURE.md](./ARCHITECTURE.md)
- ハードウェア仕様・回路 → [HARDWARE_NOTES.md](./HARDWARE_NOTES.md)
- 変更履歴 → [CHANGELOG.md](./CHANGELOG.md)

### 原則4: **行番号参照の正確性**
- ドキュメント内でコードの行番号を参照する場合は、修正後も正確か確認
- 特に [ARCHITECTURE.md](./ARCHITECTURE.md) のフロー図に注意

---

## 🔧 コーディング規約

### モジュール設計
- **単一責任の原則**: 各モジュールは1つの責務を持つ
- **依存性の注入**: ハードウェアインスタンスは初期化時に渡す
- **エラーハンドリング**: 各階層で適切にエラーを処理し、ログ出力

### ハードウェア制御
- **外部デバイス**: effects.py経由で呼び出す（統一されたエラーハンドリング）
- **オンボード機器**: 必要な箇所から直接呼び出す（システム基盤機能）

### エラー処理
- OSError: ハードウェアエラー（GPIO初期化失敗など）
- ValueError: データエラー（無効なパラメータなど）
- MemoryError: メモリ不足
- 必ず `sys.print_exception(e)` でスタックトレースを出力

---

## 🎯 新機能追加の手順

### 1. 計画フェーズ
- [ ] 追加機能の仕様を明確化
- [ ] 既存コードへの影響範囲を確認
- [ ] 必要なハードウェア・GPIO確認（[config.py](./config.py)のGPIO使用状況一覧参照）

### 2. 実装フェーズ
- [ ] 新規モジュール作成 or 既存モジュール修正
- [ ] [config.py](./config.py)に設定項目追加
- [ ] [effects.py](./effects.py)にコマンド解析追加（必要な場合）
- [ ] エラーハンドリング実装

### 3. テストフェーズ
- [ ] 実機での動作確認
- [ ] エラーケースの確認（ハードウェア未接続など）
- [ ] 既存機能への影響確認

### 4. ドキュメント更新フェーズ
- [ ] 上記「ドキュメント更新チェックリスト」を実施
- [ ] コード内コメントの充実
- [ ] [scenarios.json](./scenarios.json)にサンプル追加

---

## 📚 ドキュメント構造

```
README.md              # プロジェクト概要、使い方、クイックスタート
├─ ARCHITECTURE.md     # システム構造、モジュール詳細、設計思想
├─ HARDWARE_NOTES.md   # ハードウェア接続、GPIO、回路図、技術仕様
├─ CHANGELOG.md        # 変更履歴（日付順）
├─ DEVELOPMENT.md      # このファイル（開発ガイドライン）
└─ config.py           # 設定ファイル（コメントでGPIO使用状況も記載）
```

---

## ⚠️ 重要な注意事項

### GPIO 0 について
- **GP0は将来の拡張用に意図的に温存**されています
- 新機能でGPIOが必要な場合は、GP5-8、GP19、GP24-25、GP27-28を使用
- [config.py](./config.py)の先頭にあるGPIO使用状況一覧を必ず確認

### 後方互換性
- 既存の [scenarios.json](./scenarios.json) との互換性を維持
- JSONコマンド形式を変更する場合は、旧形式も引き続きサポート
- [effects.py](./effects.py)で両形式に対応する実装例を参考にする

### fade_controller.py の共通使用
- NeoPixelとPWM LEDのフェード処理は `fade_controller.py` を使用
- 新しいLED系デバイスを追加する場合も、この共通モジュールを活用

---

## 🔍 コードレビュー時のチェックポイント

- [ ] エラーハンドリングが適切に実装されているか
- [ ] ハードウェア未接続時でもシステムが動作するか
- [ ] stop_flag_refによる協調的キャンセルに対応しているか
- [ ] ログ出力が適切か（デバッグ情報が十分か）
- [ ] **ドキュメントが更新されているか**（最重要）
- [ ] 行番号参照が正確か（特にARCHITECTURE.md）

---

このガイドラインに従うことで、コードとドキュメントの乖離を防ぎ、プロジェクトの保守性を高く保つことができます。
