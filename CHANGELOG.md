# Changelog

本ファイルでは、プロジェクトの主要な変更履歴を記録します。

---

## [2025-12-22] - StateManagerの責任分離リファクタリング

### アーキテクチャ改善
- **状態管理の3層分離**
  - state_manager.py: 296行 → 132行（55%削減）
  - 単一責任原則に基づく分離設計

- **新規ファイル（責任分離層）**
  - `button_handler.py`: **新規作成** - ボタン入力処理専用（短押し・長押し・ダブルクリック検出）
  - `playback_manager.py`: **新規作成** - シナリオ再生管理専用（スレッド管理、エラーハンドリング）
  - `autoplay_controller.py`: **新規作成** - 自動再生制御専用（アイドル監視、ワークショップモード）

### 改善内容
- **デバッグ容易性向上**: 問題領域を特定しやすい構造（ボタン問題 → button_handler.py のみ確認）
- **保守性向上**: 各クラスが単一責任（ボタン処理、再生管理、自動再生制御）
- **再利用性向上**: 独立したコンポーネントとして他プロジェクトでも利用可能
- **テスト容易性向上**: 各クラスを個別にテスト可能
- **後方互換性維持**: 既存のloop_controller.pyは変更不要

### 設計パターン
- effects.pyリファクタリングと同じ責任分離パターン
- 「神クラス」から専門クラスへの分解
- インターフェース互換性の維持（is_playing, stop_flag プロパティ）

---

## [2025-12-22] - effects.pyの大規模リファクタリング（3層アーキテクチャ化）

### アーキテクチャ改善
- **3層アーキテクチャへの再設計**
  - effects.py（ディスパッチャー層）: 454行 → 145行（68%削減）
  - コマンドハンドラー層（中間層）: 新規追加
  - 既存モジュール層: 変更なし

- **新規ファイル（コマンドハンドラー層）**
  - `command_parser.py`: **新規作成** - JSON解析・バリデーション・stop_flag監視の共通処理
  - `servo_command_handler.py`: **新規作成** - サーボモーターコマンド処理（連続回転型/角度制御型自動判別）
  - `led_command_handler.py`: **新規作成** - NeoPixel LEDコマンド処理
  - `pwm_led_command_handler.py`: **新規作成** - PWM LED（単色LED）コマンド処理
  - `motor_command_handler.py`: **新規作成** - ステッピングモーターコマンド処理
  - `sound_command_handler.py`: **新規作成** - DFPlayer Miniコマンド処理

### 改善内容
- **保守性向上**: 各デバイスの処理が独立したファイルに分離（100-150行/ファイル）
- **可読性向上**: effects.pyはコマンドタイプ判定のみのシンプルな構造
- **拡張性向上**: 新デバイス追加時はハンドラー1ファイル追加のみ
- **コード重複削減**: 共通処理をcommand_parser.pyに集約
- **エラーハンドリング統一**: safe_call()による一貫したエラー処理

### 設計パターン
- fade_controller.py、servo_pwm_utils.pyに続く共通処理抽出パターン
- 既存のARCHITECTURE.mdの設計思想に完全準拠
- 後方互換性維持（既存シナリオそのまま動作）

---

## [2025-12-22] - サーボモーター制御機能の追加

### 新機能
- **サーボモーター制御機能の実装**
  - `servo_rotation_controller.py`: **新規作成** - 連続回転サーボ（SG90-HV等）の制御モジュール
  - `servo_position_controller.py`: **新規作成** - 角度制御サーボ（SG90等）の制御モジュール
  - GP5, GP6, GP7で最大3個のサーボを独立制御
  - 速度制御（-100～100）: 正転・逆転・停止を精密に指定
  - 時間制御回転: 指定時間だけ回転して自動停止
  - 継続回転モード: 次のコマンドまで回転継続
  - 協調的キャンセル対応: ボタン操作で回転を中断可能
  - PWM信号制御（50Hz、パルス幅1000-2000μs）

- **config.pyの拡張**
  - `SERVO_PINS`: サーボモーターのGPIOピン定義（[5, 6, 7]）
  - `SERVO_FREQUENCY`: PWM周波数（50Hz）
  - `SERVO_ROTATION_CHECK_INTERVAL_MS`: 停止フラグチェック間隔（50ms）
  - GPIO使用状況一覧を更新: GP5-7がサーボ制御に割り当て（使用中22ピン、空き6ピン）

- **effects.pyの拡張**
  - サーボコマンド処理を追加: `{"type": "servo", "command": "rotate", ...}`
  - ステッピングモーター（`type: "motor"`）と明確に区別

- **テストシナリオの追加**
  - `test_servo_basic`: 正転・逆転の基本動作
  - `test_servo_cycle`: 連続往復動作
  - `test_servo_multi`: 複数サーボ同時制御

### システム統合
- `hardware_init.py`: 両タイプのサーボ初期化処理を追加
- `system_init.py`: servo_rotation_controller、servo_position_controllerモジュールのインポートと初期化
- `effects.py`: config.pyのSERVO_TYPESに基づいて自動判別・振り分け

### ドキュメント更新
- README.md: サーボモーター機能の説明とコマンドリファレンスを追加
- GPIO使用状況を明記（GP5-7をサーボ制御に使用）

---

## [2025-12-22] - LED制御機能の大幅強化とフェード処理の共通化

### 主な変更点
  - **PWM LED制御機能の追加**
    - `pwm_led_controller.py`: 単色LED（GP1-4）をPWM制御するモジュールを新規作成
    - 輝度制御（0-100%）、ガンマ補正（γ=2.2）による自然な明るさ変化
    - フェードイン/フェードアウト機能（10msステップの滑らかな変化）
    - 最大4個のLEDを個別に制御可能
    - ボタン操作による協調的キャンセル対応
    - **注意**: LED接続時は必ず電流制限抵抗（150-330Ω推奨）を使用
  
  - **内蔵LED制御機能の追加**
    - `onboard_led.py`: Raspberry Pi Pico 2WのWi-Fiチップ上LED制御モジュールを新規作成
    - システム状態表示（起動時3回点滅）
    - 再生中の可視化、デバッグ支援機能
  
  - **フェード処理の共通化**
    - `fade_controller.py`: **新規作成** - PWM LEDとNeoPixel両方で使用する汎用フェード処理
    - 線形フェード処理を一元化（数値、RGB色の両方に対応）
    - キャンセル可能な待機処理も提供
    - コードの重複を削減し、保守性を大幅に向上
  
  - **NeoPixel制御の改善**
    - `neopixel_controller.py`: フェード処理を共通モジュール使用に変更
    - グローバルインデックス管理により全60個のLEDを統合制御
    - 色キャッシュ機能で効率的な状態管理
  
  - **effects.pyの拡張**
    - PWM LED用コマンド（`led_on`, `led_off`, `led_fade_in`, `led_fade_out`, `wait_ms`）のサポート追加
    - NeoPixel用コマンド（`effect fade`, `effect global_set`, `effect off`）の改善
    - 既存のscenarios.json定義はそのまま動作（後方互換性維持）
  
  - **config.pyの拡張**
    - PWM LED設定（ピン配列、周波数、ガンマ値等）を追加
    - 内蔵LED設定を追加
  
  - **ドキュメント整備**
    - `readme.md`: LED制御機能の詳細説明を追加
    - `HARDWARE_NOTES.md`: PWM LED/NeoPixel/内蔵LEDの配線、抵抗計算、機能詳細を追加
    - 安全上の注意（抵抗なし接続の危険性）を強調

- **技術的改善**
  - フェードアルゴリズムの統一により、変更が1箇所で完結
  - PWMガンマ補正により視覚的に自然な明るさ変化を実現
  - 10msステップの高精度なフェード処理
  - 協調的キャンセル機構でユーザー操作への即応性向上

- **新規追加ファイル**
  - `fade_controller.py` - 共通フェード処理
  - `pwm_led_controller.py` - PWM LED制御
  - `onboard_led.py` - 内蔵LED制御

---

## [2025-11-06]
### 定数の一元管理による保守性向上

- **主な変更点**
  - `config.py`: 各種設定値を定数として追加
    - **ボタン操作の閾値**
      - `BUTTON_SHORT_PRESS_MS = 500`: 短押し判定時間（ミリ秒）
      - `BUTTON_LONG_PRESS_MS = 1000`: 長押し判定時間（ミリ秒）
      - `BUTTON_DOUBLE_CLICK_INTERVAL_MS = 500`: ダブルクリック判定間隔（ミリ秒）
    - **自動再生設定**
      - `AUTO_PLAY_INTERVAL_SECONDS = 60`: アイドル後の自動再生間隔（秒）
    - **エラーハンドリング設定**
      - `ERROR_RETRY_DELAY_MS = 1000`: エラー発生時の待機時間（ミリ秒）
    - **内蔵LED設定**
      - `ONBOARD_LED_BLINK_TIMES = 2`: 起動時の点滅回数
      - `ONBOARD_LED_ON_TIME_MS = 300`: 点灯時間（ミリ秒）
      - `ONBOARD_LED_OFF_TIME_MS = 200`: 消灯時間（ミリ秒）
    - **OLED表示設定**
      - `OLED_LINE_HEIGHT = 10`: 行の高さ（ピクセル）
      - `OLED_MAX_LINES = 4`: 最大表示行数
      - `OLED_I2C_RETRY_COUNT = 1`: I2Cタイムアウト時のリトライ回数
  - `state_manager.py`: ボタン判定処理で定数を参照
  - `loop_controller.py`: エラーリトライ設定を定数化
  - `system_init.py`: 内蔵LED動作を定数化
  - `oled_patterns.py`: 表示設定を定数化
  - `readme.md`: アイドル自動再生機能とボタン操作のカスタマイズ方法を追記

- **改善効果**
  - 全ての調整可能な値を `config.py` に集約
  - マジックナンバーの完全排除
  - カスタマイズが1ファイルで完結
  - コードの可読性と保守性が大幅に向上
  - 既存の動作は完全に保持（デフォルト値は従来と同じ）

---

## [2025-11-05]
### エラーハンドリングの強化（システム安定性向上）

- **主な変更点**
  - `state_manager.py`: 再生処理の例外処理を詳細化
    - OSError（ハードウェアエラー）、KeyError（データエラー）、MemoryError等を個別にキャッチ
    - エラー時にOLEDへのメッセージ表示を追加
    - スタックトレース出力によるデバッグ情報の充実
  - `effects.py`: コマンド実行時のエラーハンドリング改善
    - 各コマンド実行を個別にtry-catchでラップし、エラーが発生しても次のコマンドを継続
    - カラー値の範囲チェック、負の遅延時間の検証を追加
    - モーター停止処理を確実に実行するようfinally句を強化
  - `system_init.py`: 初期化プロセスの堅牢化
    - JSONファイル読み込み、ハードウェア初期化、ボリューム初期化の各段階でエラーハンドリング
    - エラー時はフォールバックシナリオやダミーコントローラで動作継続
    - エラー種別に応じた適切なメッセージ表示
  - `loop_controller.py`: **新規追加** - メインループロジックを分離
    - LoopControllerクラスでメインループの制御を一元化
    - ボリューム、ボタン、再生処理を個別にエラーハンドリング
    - KeyboardInterruptによる正常終了をサポート
    - クリーンアップ処理を保証
  - `main.py`: メインループのリファクタリング
    - ループ制御ロジックをloop_controller.pyに移管
    - コード量を大幅削減し、可読性を向上
    - 初期化とループ実行の責務を明確に分離

- **改善効果**
  - ハードウェア障害時の部分的な動作継続が可能に
  - エラー原因の特定が容易になり、デバッグ効率が向上
  - システムの予期しない停止を大幅に削減
  - コードの保守性とテスタビリティが向上

---

## [2025-11-03]
### 状態管理・モード制御ロジックの刷新
`state_manager.py` と `system_init.py` を導入し、システム構造を再設計。

- **主な変更点**
  - `system_init.py`: 全ハードウェアおよびモジュールの初期化を一括管理。構成情報を `config.py` から取得。
  - `state_manager.py`: ボタン入力、再生制御、OLED表示、アイドル状態管理を統合。
  - `main.py`: イベントループ主体の軽量設計に変更し、状態更新 (`update_playback`, `check_idle_autoplay`) のみを実行。
  - セレクトモード改良：シナリオ選択後もモードが維持され連続再生が可能に。
  - 通常モードとアイドル自動再生が安定化。
  - **ステッピングモーター対応追加**
    - `stepper_motor.py` モジュールを作成し、小型ステッピングモーターを制御可能に。
    - 角度指定・ステップ指定・回転方向・速度の指定が可能。
    - `effects.py` 内でシナリオからモーター制御コマンド (`rotate`, `step`) を実行できるように統合。
    - 再生中止時には通電解除して安全停止。

---

## [2025-11-01]
### main.py のスリム化と表示・初期化ロジックの分割

- **追加モジュール**
  - `volume_control.py`: ボリューム制御（ADC→DFPlayer反映）
  - `hardware_init.py`: 各ハードウェア初期化
  - `display_manager.py`: OLED出力の一元化
  - `onboard_led.py`: 内蔵LED制御（状態表示・デバッグ用途）
  - `system_init.py`: システム全体の初期化統合（NEW）
  - `state_manager.py`: モード・再生・ボタン統合管理（NEW）

---

### 🧩 管理ルール
- **README.md** はシステム概要・使い方中心に保つ。  
- **CHANGELOG.md** は技術的な変更履歴とリリース記録を集約。  
- 各リリースは `[YYYY-MM-DD]` 形式でセクションを追加。
