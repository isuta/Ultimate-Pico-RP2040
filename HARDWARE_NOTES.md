# ハードウェア接続ガイド

このドキュメントでは、Ultimate-Pico-RP2040プロジェクトで使用するハードウェアコンポーネントの接続方法と注意事項を説明します。

---

## ⚠️ 重要な安全上の注意

### PWM LED接続時の必須事項

**抵抗なしでLEDを直接GPIOに接続すると、LEDおよびPicoボードが破損します。**

#### 危険性:
- **過電流によるLED焼損**: 定格電流20mAに対し、数百mAが流れる可能性
- **GPIOピン破損**: Pico GPIOの最大電流（12-16mA）を大幅に超過
- **ボード全体の故障**: 最悪の場合、Picoボード自体が故障

#### 正しい接続方法:

```
GPIO → [電流制限抵抗] → LED+ → LED- → GND
```

**必ず各LEDに適切な電流制限抵抗を接続してください。**

---

## 📐 LED抵抗値の計算

### 計算式

```
R = (Vsupply - Vf) / If

Vsupply = 3.3V (Pico GPIO出力電圧)
Vf      = LED順方向電圧
If      = LED順方向電流 (推奨: 10-20mA)
```

### 推奨抵抗値

| LED色 | Vf (標準) | 推奨抵抗 | 流れる電流 | 備考 |
|------|----------|---------|----------|------|
| 赤色 | 2.0V | 150Ω | 約8.7mA | 標準的な赤色LED |
| 黄色 | 2.1V | 150Ω | 約8.0mA | 標準的な黄色LED |
| 緑色 | 2.2V | 150Ω | 約7.3mA | 標準的な緑色LED |
| 青色 | 3.0V | 100Ω | 約3.0mA | 高輝度青色LED |
| 白色 | 3.0V | 100Ω | 約3.0mA | 高輝度白色LED |

**安全マージンを取る場合は220Ωまたは330Ωを使用してください。**

### 計算例

**赤色LED（Vf=2.0V）、電流10mAの場合:**
```
R = (3.3V - 2.0V) / 0.01A = 130Ω
→ 近似値: 150Ω (標準抵抗値)
```

### 抵抗値と明るさの関係

**抵抗値が高いほどLEDは暗くなります。**

```
抵抗値↑ → 電流↓ → 明るさ↓
抵抗値↓ → 電流↑ → 明るさ↑
```

#### 抵抗値別の明るさ比較（赤色LED、Vf=2.0V）

| 抵抗値 | 電流 | 明るさ | 用途 |
|--------|------|--------|------|
| 100Ω | 13mA | ★★★★★ | 非常に明るい（定格ギリギリ） |
| 150Ω | 8.7mA | ★★★★☆ | 明るい（推奨・バランス良好） |
| 220Ω | 5.0mA | ★★★☆☆ | 普通（省電力、インジケータ用） |
| 330Ω | 3.3mA | ★★☆☆☆ | やや暗い（超省電力、夜間使用） |
| 470Ω | 2.3mA | ★☆☆☆☆ | 暗い（確認用、ステータス表示） |

#### 抵抗値の選び方

**明るさ重視:**
- **150Ω**: 良好なバランス、8.7mA（推奨）
- GPIO電流制限（12-16mA）内で安全

**安全性重視:**
- **220Ω**: 電流5mA、十分実用的な明るさ
- **330Ω**: 電流3.3mA、超安全、ただしやや暗い

**実用的な推奨:**
```
室内での視認性重視: 150Ω
省電力/安全重視: 220Ω
夜間使用/まぶしさ軽減: 330Ω
```

#### PWM制御との組み合わせ

このプロジェクトでは**PWMで輝度を0-100%制御できます**。

```
抵抗150Ω + PWM 100% = 最大の明るさ（8.7mA）
抵抗150Ω + PWM 50%  = 中程度の明るさ（約4.3mA）
抵抗150Ω + PWM 10%  = 薄暗い（約0.9mA）
```

**推奨**: 明るさが必要な場合は**150Ω**、安全マージンを重視する場合は**220Ω**が最適です。PWMで後から明るさ調整できるため、基本的には**150Ωを推奨**します。

---

## 🔌 GPIO ピンアサイン

### PWM LED (単色LED制御)

| LEDインデックス | GPIOピン | 物理ピン | PWMチャネル |
|-------------|---------|---------|-----------|
| LED #0 | GP1 | Pin 2 | PWM0_B |
| LED #1 | GP2 | Pin 4 | PWM1_A |
| LED #2 | GP3 | Pin 5 | PWM1_B |
| LED #3 | GP4 | Pin 6 | PWM2_A |

**注**: GP0は将来の拡張用に温存しています。

**PWM LED機能:**
- **ガンマ補正**: 人間の視覚特性に合わせた自然な明るさ変化（γ=2.2）
- **滑らかなフェード**: 共通フェード処理（fade_controller.py）により10msステップで段階的に輝度を変化
- **個別制御**: 4個のLEDを独立して制御可能
- **協調的キャンセル**: ボタン操作でフェード処理を中断可能
- **輝度キャッシュ**: 各LEDの現在輝度を保持

**技術詳細:**
- PWM周波数: 1kHz（ちらつき防止）
- 16bit PWM（0-65535）
- フェードステップ: 10ms間隔
- 電流制限: GPIO最大12-16mA内で安全動作

### NeoPixel LED (RGB LEDストリップ)

| ストリップ名 | GPIOピン | 物理ピン | LED数 (デフォルト) |
|-----------|---------|---------|-----------------|
| LV1 | GP20 | Pin 26 | 15個 |
| LV2 | GP21 | Pin 27 | 15個 |
| LV3 | GP22 | Pin 29 | 15個 |
| LV4 | GP23 | Pin 31 | 15個 |

**NeoPixelは内部に電流制御回路があるため、抵抗は不要です。**

**NeoPixel機能:**
- **フェード機能**: 共通フェード処理（fade_controller.py）により10msステップで滑らかな色変化
- **グローバルインデックス**: 全60個のLEDを統合管理
- **色キャッシュ**: 各LEDの現在色を保持し効率的に復元
- **個別/一括制御**: ストリップ単位または全LED一括制御

**技術詳細:**
- データ速度: 800kHz（WS2812B規格）
- 色解像度: RGB各8bit（0-255）
- フェードステップ: 10ms間隔
- 電流制限回路内蔵（抵抗不要）

### DFPlayer Mini (音声再生)

| 信号 | GPIOピン | 物理ピン | 用途 |
|------|---------|---------|------|
| TX | GP12 | Pin 16 | UART送信 |
| RX | GP13 | Pin 17 | UART受信 |
| BUSY | GP14 | Pin 19 | ビジー信号入力 |

**UART通信のため、TXとRXのクロス接続に注意してください。**
- Pico TX (GP12) → DFPlayer RX
- Pico RX (GP13) → DFPlayer TX

### OLED ディスプレイ (SSD1306)

| 信号 | GPIOピン | 物理ピン | 用途 |
|------|---------|---------|------|
| SDA | GP16 | Pin 21 | I2Cデータ |
| SCL | GP17 | Pin 22 | I2Cクロック |

### ステッピングモーター

| 信号 | GPIOピン | 物理ピン | モーター端子 |
|------|---------|---------|-----------|
| AIN1 | GP9 | Pin 12 | AOUT1 |
| AIN2 | GP10 | Pin 14 | AOUT2 |
| BIN1 | GP11 | Pin 15 | BOUT1 |
| BIN2 | GP15 | Pin 20 | BOUT2 |

### サーボモーター（連続回転型） ⭐

| サーボID | GPIOピン | 物理ピン | PWMチャネル |
|---------|---------|---------|-----------|
| Servo #0 | GP5 | Pin 7 | PWM2_B |
| Servo #1 | GP6 | Pin 9 | PWM3_A |
| Servo #2 | GP7 | Pin 10 | PWM3_B |

**対応モデル:** SG90-HV等の連続回転型サーボモーター

**仕様:**
- **動作電圧**: 4.8-6.0V（独立した電源供給推奨）
- **PWM周波数**: 50Hz（サーボモーター標準）
- **パルス幅範囲**: 1000～2000μs
  - 1000μs: 最高速反時計回り（CCW）
  - 1500μs: 停止
  - 2000μs: 最高速時計回り（CW）
- **速度制御**: -100～100（0=停止）
- **最大消費電流**: 約200-300mA/個（負荷時）

**接続方法:**
```
サーボ茶色線（GND） → Picoと共通GND
サーボ赤色線（VCC） → 外部5V電源（4.8-6.0V）
サーボ黄色線（信号） → Pico GPIOピン（GP5/6/7）
```

**⚠️ 重要な注意事項:**
- **外部電源必須**: サーボモーターの消費電流が大きいため、Picoの3.3Vや5V出力からは給電しないでください
- **共通GND**: 外部電源のGNDとPicoのGNDを必ず接続
- **複数接続時**: 各サーボが最大300mA消費する可能性があるため、十分な容量の電源を用意
- **ステッピングモーターとの違い**: 
  - サーボ: PWM制御、連続回転、速度指定
  - ステッピング: デジタル制御、ステップ単位、角度指定

**サーボモーター機能:**
- **速度制御**: -100～100の範囲で回転速度を設定
- **時間指定回転**: 指定時間だけ回転させる機能
- **協調的キャンセル**: ボタン操作で回転を中断可能
- **独立制御**: 最大3個のサーボを同時に異なる速度で制御可能

**技術詳細:**
- PWM周波数: 50Hz固定（サーボモーター規格）
- デューティサイクル: パルス幅1000-2000μsを自動変換
- 回転チェック間隔: 50ms（時間指定回転時）
- 16bit PWM（0-65535デューティ値）

### ユーザー入力

| 機能 | GPIOピン | 物理ピン | 接続 |
|------|---------|---------|------|
| タクトスイッチ | GP18 | Pin 24 | プルダウン抵抗付き |
| ポテンショメータ | GP26 (ADC0) | Pin 31 | ボリューム調整 |

### 内蔵LED

| 機能 | 識別子 | 備考 |
|------|--------|------|
| 内蔵LED | "LED" | Pico 2WのWi-Fiチップ上LED |

**機能:**
- **システム状態表示**: 起動完了時に3回点滅
- **動作確認**: シナリオ再生中の可視化
- **デバッグ支援**: エラー状態の表示

**注意:**
- Pico 2W専用（Pico/Pico W/Pico 2では使用できません）
- プログラムで制御可能（`onboard_led.py`）
- 抵抗不要（内蔵LEDのため）

---

## 🔧 ハードウェア設定の変更方法

全てのピン設定は `config.py` に集約されています。

### GPIO番号を変更する場合

1. `config.py` の該当する定数を編集
2. **物理的な配線も変更**
3. I2CやUARTのピン番号は各ペリフェラルの制約に従う
4. 実機で動作確認

### NeoPixel LED数の変更

```python
# config.py
NEOPIXEL_STRIPS = {
    'LV1': {'pin': 20, 'count': 30},  # 15 → 30に変更
    # ...
}
```

実際に接続したLED数に合わせて調整してください。

---

## 🛠️ 接続トラブルシューティング

### PWM LEDが点灯しない

1. **抵抗は接続していますか？** → 150-330Ω推奨
2. **LED極性は正しいですか？** → アノード(+)をGPIO側、カソード(-)をGND側
3. **GPIO番号は正しいですか？** → GP1-4を使用
4. **電源は供給されていますか？** → Picoが正常に起動しているか確認

### NeoPixelが点灯しない

1. **データ線は接続されていますか？** → GP20-23
2. **電源は十分ですか？** → NeoPixelは多くの電流を消費（1LED最大60mA）
3. **LED数は正しく設定されていますか？** → `config.py`のcountを確認
4. **ストリップの向きは正しいですか？** → データの方向矢印を確認

### OLEDが表示しない

1. **I2C配線は正しいですか？** → SDA=GP16, SCL=GP17
2. **I2Cアドレスは正しいですか？** → 通常0x3C（一部0x3D）
3. **電源電圧は適切ですか？** → 3.3Vまたは5V（モジュールによる）
4. **プルアップ抵抗はありますか？** → 多くのモジュールには内蔵済み

### DFPlayerが音を出さない

1. **UART配線は正しいですか？** → TX/RXがクロス接続されているか
2. **SDカードは挿入されていますか？** → フォーマット形式はFAT32
3. **音声ファイルの配置は正しいですか？** → `/01/001.mp3`形式
4. **スピーカーは接続されていますか？** → 8Ω、3W程度推奨
5. **電源は十分ですか？** → DFPlayerは別電源推奨（5V、500mA以上）

### ステッピングモーターが動かない

1. **ドライバボードは正しく接続されていますか？** → GPIO9,10,11,15
2. **電源は供給されていますか？** → モーター用電源（通常5-12V）
3. **モーターの定格は適切ですか？** → ドライバの許容範囲内か確認

### サーボモーターが動かない ⭐

1. **PWM信号線は接続されていますか？** → GP5-7の該当ピン
2. **共通GNDは接続されていますか？** → Picoと外部電源のGNDを接続
3. **外部電源は供給されていますか？** → 4.8-6.0V、十分な容量（各サーボ最大300mA）
4. **Picoの3.3Vや5Vから給電していませんか？** → 外部電源を使用してください
5. **速度は設定されていますか？** → 速度0では停止状態です
6. **配線は正しいですか？**
   - 茶色（GND）→ 外部電源GND + PicoGND
   - 赤色（VCC）→ 外部電源5V（4.8-6.0V）
   - 黄色（信号）→ Pico GPIOピン

### サーボモーターの動作が不安定

1. **電源容量は十分ですか？** → 複数接続時は各300mA×個数の容量が必要
2. **ノイズ対策していますか？** → 電源ラインにバイパスコンデンサ（100μF程度）推奨
3. **配線が長すぎませんか？** → 信号線は20cm以下推奨、長い場合は抵抗（330Ω）をGPIO側に追加
4. **複数のサーボを同時駆動していませんか？** → 突入電流に注意、時間差起動推奨
4. **配線の極性は正しいですか？** → AとBのコイルを確認

---

## 📋 推奨部品仕様

### PWM LED
- **種類**: 3mm/5mm標準LED、または高輝度LED
- **定格電流**: 20mA（標準）
- **順方向電圧**: 赤(2.0V)、緑(2.2V)、青/白(3.0V)
- **推奨抵抗**: 150-330Ω (1/4W)

### NeoPixel
- **規格**: WS2812B / SK6812
- **電圧**: 5V
- **電流**: 最大60mA/LED (RGB全点灯時)
- **データ速度**: 800kHz

### 電源要件
- **Pico本体**: 5V、100-200mA（基本動作時）
- **NeoPixel**: 5V、LED数×60mA（最大時）
- **DFPlayer**: 5V、200-500mA
- **ステッピングモーター**: 5-12V（モーターによる）

**大量のNeoPixelやモーターを使用する場合は、Picoと別に専用電源を用意してください。**

---（LED機能追加の詳細など）
- [fade_controller.py](./fade_controller.py) - 共通フェード処理の実装

## 🔗 関連ドキュメント

- [README.md](./README.md) - プロジェクト概要と使い方
- [config.py](./config.py) - ピン設定と動作パラメータ
- [CHANGELOG.md](./CHANGELOG.md) - 変更履歴

---

## 📞 サポート

配線やハードウェアに関する問題が解決しない場合は、以下を確認してください:
1. シリアルモニタのログ出力
2. `config.py` の設定値
3. 各モジュールの初期化成功/失敗メッセージ
4. ハードウェアの物理的な接続状態

**安全第一**: 不明な点がある場合は、通電前に配線を再確認してください。
