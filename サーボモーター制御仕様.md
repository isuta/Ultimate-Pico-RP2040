# サーボモーター制御システム追加仕様書

## 1. 概要

本システムは、Raspberry Pi Pico 2Wの空きGPIOピン（**GP5～GP7**）に接続された360°連続回転サーボモーター（**SG90-HV**想定）を、PWM信号を用いて制御するために導入されます。

### 最大の特徴
- **JSON（Python辞書）ベースのシナリオ定義**
- **ブロッキング実行と停止フラグ対応**
- **最優先でのシナリオ割り込み**
- **複数サーボ対応**: 最大3個のサーボを独立制御可能
- **速度・回転方向・時間による精密制御**

これにより、サーボ動作中でも、他のハードウェアモジュール（LED、音声、ディスプレイ等）との複合演出が可能になります。

### GPIO割り当て
| GPIO | PWMチャネル | 物理ピン | 用途 |
|------|------------|---------|------|
| GP5 | PWM2_B | 7 | 連続回転サーボ #0 |
| GP6 | PWM3_A | 9 | 連続回転サーボ #1 |
| GP7 | PWM3_B | 10 | 連続回転サーボ #2 |

**注**: GP8も空きですが、将来の拡張用に温存します。

### サーボモーター仕様（SG90-HV）
- **動作電圧**: 4.8V～6.0V（推奨5V）
- **消費電流**:
  - 無負荷時: 約100-200mA
  - 負荷時（最大トルク）: 約500-800mA
  - 起動時瞬間電流: 約1A以上
- **最大トルク**: 1.5kgf・cm
- **最大速度**: 130rpm
- **PWM周波数**: 50Hz（標準的なサーボ仕様）
- **パルス幅範囲**:
  - 1000μs (1.0ms): 左回転（最速）
  - 1500μs (1.5ms): 停止
  - 2000μs (2.0ms): 右回転（最速）
- **動作原理**: パルス幅に応じて回転速度が変化（連続回転タイプ）

### ステッピングモーターとの違い
| 項目 | ステッピングモーター | サーボモーター（連続回転） |
|------|---------------------|-------------------------|
| 制御方式 | **角度指定**（degrees） | **時間指定**（duration_ms） |
| 停止判定 | 目標角度到達で自動停止 | 指定時間経過で自動停止 or 継続回転 |
| 位置保持 | 可能（通電中は保持） | 不可（位置フィードバックなし） |
| トルク | 停止時も高トルク | 回転時のみトルク発生 |
| 用途 | 精密な位置決め、角度制御 | 連続回転、速度制御 |
| JSON例 | `{"type": "motor", "command": "rotate", "angle": 90}` | `{"type": "servo", "command": "rotate", "speed": 70, "duration_ms": 2000}` |

---

## 2. 影響ファイルと役割

| ファイル名 | 役割 | 変更点 |
|-----------|------|--------|
| `config.py` | ハードウェア定義 | 新しいサーボモーター設定配列 (`SERVO_PINS = [5, 6, 7]`)、PWM周波数 (`SERVO_FREQUENCY = 50`)、パルス幅範囲、デフォルト速度等を追加 |
| **`servo_controller.py`** | **サーボモーター制御ロジック（新規作成）** | **サーボの初期化、速度設定、時間制御回転、停止処理を行う関数群を定義（ブロッキング方式、`stop_flag_ref`対応）** |
| `system_init.py` | システム初期化 | `servo_controller`の初期化を追加、起動時のサーボ状態確認 |
| `hardware_init.py` | ハードウェア初期化 | `servo_controller`の初期化呼び出しを追加 |
| `effects.py` | エフェクト実行エンジン | サーボモーターコマンド処理（`servo_rotate`, `servo_stop`, `servo_speed`）を追加 |
| `state_manager.py` | 状態管理 | サーボ用の停止フラグ管理を追加（オプション） |
| `main.py` | メインアプリケーション | `servo_controller`のインポートと初期化処理を追加（必要に応じて） |

---

## 3. シナリオ定義とファイル統合

### シナリオファイル構成

サーボモーターのシナリオは、**既存の`scenarios.json`に統合**します。

**理由:**
1. **ランダム再生との互換性**: 既存の`random_scenarios`に自動的に含まれる
2. **複合演出が可能**: サウンド、NeoPixel、PWM LED、ステッピングモーター、サーボモーターを1つのシナリオで組み合わせ可能
3. **実装がシンプル**: `effects.py`にサーボモーターコマンド処理を追加するだけ
4. **ユーザー体験の一貫性**: すべてのシナリオが同じファイル、同じ操作方法

### シナリオ例：複合演出

```json
{
    "combined_servo_effect": [
        ["sound", 2, 1],
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 70, "duration_ms": 2000},
        {"led_fade_in": {"led_index": 0, "duration_ms": 500, "max_brightness": 80}},
        {"wait_ms": 500},
        {"type": "servo", "command": "stop", "servo_index": 0},
        {"type": "servo", "command": "rotate", "servo_index": 1, "speed": -50, "duration_ms": 1500},
        {"wait_ms": 1000},
        {"type": "servo", "command": "stop", "servo_index": 1},
        {"led_fade_out": {"led_index": 0, "duration_ms": 500}}
    ]
}
```

このシナリオは以下を実行します：
- サウンド再生（DFPlayer）
- サーボ #0 を速度70%で2秒間回転（`type: "servo"`でサーボモーターを指定）
- PWM LED #0 のフェードイン
- 0.5秒待機
- サーボ #0 を停止
- サーボ #1 を速度-50%（逆回転）で1.5秒間回転
- 1秒待機
- サーボ #1 を停止
- PWM LED #0 のフェードアウト

**ステッピングモーターとの区別:**
- **ステッピングモーター**: `{"type": "motor", "command": "rotate", ...}` （既存）
- **サーボモーター**: `{"type": "servo", "command": "rotate", ...}` （新規）

### `effects.py`への実装

`execute_command()`関数にサーボモーターコマンド処理を追加：

```python
# effects.py の execute_command() 内に追加
import servo_controller

def execute_command(command_list, stop_flag_ref):
    for cmd in command_list:
        # ... 既存の処理（sound, delay, motor, led等）...
        
        # サーボモーター制御コマンドの追加（辞書形式）
        if is_dict_format:
            cmd_type = cmd.get("type")
            
            if cmd_type == 'servo':
                if not servo_controller.is_servo_available():
                    print("サーボ制御スキップ（モジュール未初期化）")
                    continue
                
                command = cmd.get("command")
                servo_index = cmd.get("servo_index", 0)
                
                if command == "rotate":
                    speed = cmd.get("speed", 0)  # -100～100
                    duration_ms = cmd.get("duration_ms", 0)
                    
                    if duration_ms > 0:
                        # 時間指定回転（ブロッキング、stop_flag対応）
                        servo_controller.rotate_timed(servo_index, speed, duration_ms, stop_flag_ref)
                    else:
                        # 継続回転（ノンブロッキング）
                        servo_controller.set_speed(servo_index, speed)
                
                elif command == "stop":
                    servo_controller.stop(servo_index)
                
                elif command == "stop_all":
                    servo_controller.stop_all()
                
                else:
                    print(f"[Warning] Unknown servo command: {command}")
            
            elif cmd_type == 'motor':
                # 既存のステッピングモーター制御（変更なし）
                if not motor:
                    print("モーター制御スキップ（モジュール未初期化）")
                    continue
                # ...
```

---

## 4. シナリオJSON定義仕様

サーボモータ形式 | 機能 | パラメータ（必須/任意） | 説明 |
|-------------|------|----------------------|------|
| `{"type": "servo", "command": "rotate", ...}` | 回転制御 | `servo_index` (任意, デフォルト: 0)<br>`speed` (必須, -100～100)<br>`duration_ms` (任意, 0=継続回転) | 指定されたサーボ（0-2）を`speed`で指定された速度（-100〜100）で回転させます。<br>- `speed > 0`: 正転<br>- `speed < 0`: 逆転<br>- `speed = 0`: 停止<br>- `duration_ms > 0`: 指定時間回転後に自動停止（ブロッキング、**停止フラグ対応**）<br>- `duration_ms = 0`または省略: 継続回転（次のコマンドまで継続） |
| `{"type": "servo", "command": "stop", ...}` | 単体停止 | `servo_index` (任意, デフォルト: 0) | 指定されたサーボ（0-2）を停止します |
| `{"type": "servo", "command": "stop_all"}` | 全サーボ停止 | なし | すべてのサーボを一括停止します |
| `{"wait_ms": <duration>}` | 待機（ブロッキング） | `duration_ms` (必須) | シナリオの進行を`duration_ms`間停止します。**停止フラグで中断可能** |
| `{"stop_playback": true}` | 全モジュール停止 | なし | 現在実行中の音声・LED等を停止します（**注**: モーター類は停止しません） |

**ステッピングモーターとの区別:**
- **ステッピングモーター（既存）**: `{"type": "motor", "command": "rotate", "angle": 90, ...}`
- **サーボモーター（新規）**: `{"type": "servo", "command": "rotate", "servo_index": 0, "speed": 70, ...}`
| `repeat` | 整数 | 任意 | シナリオ全体の繰り返し回数<br>- `1`：1回のみ実行（デフォルト）<br>- `3`：3回繰り返す<br>- `0` または `-1`：無限ループ（`stop_scenario`が呼ばれるまで） |
| `steps` | 配列 | 必須 | シナリオを構成するコマンドのリスト。上から順番に実行されます |

### 4.2. コマンド定義とパラメータ

**すべての動作時間指定はミリ秒（ms）で統一されます。**

| コマンドキー | 機能 | パラメータ（必須/任意） | 説明 |
|-------------|------|----------------------|------|
| `servo_rotate` | 回転制御 | `servo_index` (任意, デフォルト: 0)<br>`speed` (必須, -100～100)<br>`duration_ms` (任意, 0=継続回転) | 指定されたサーボ（0-2）を`speed`で指定された速度（-100〜100）で回転させます。<br>- `speed > 0`: 正転<br>- `speed < 0`: 逆転<br>- `speed = 0`: 停止<br>- `duration_ms > 0`: 指定時間回転後に自動停止（ブロッキング、**停止フラグ対応**）<br>- `duration_ms = 0`または省略: 継続回転（次のコマンドまで継続） |
| `servo_stop` | 単体停止 | `servo_index` (任意, デフォルト: 0) | 指定されたサーボ（0-2）を停止します |
| `servo_all_stop` | 全サーボ停止 | なし | すべてのサーボを一括停止します |
| `wait_ms` | 待機（ブロッキング） | `duration_ms` (必須) | シナリオの進行を`duration_ms`間停止します。**停止フラグで中断可能** |
| `stop_playback` | 全モジュール停止 | なし | 現在実行中の全ての処理（音声、LED、モーター、サーボ等）を停止します |

**速度パラメータ（speed）の詳細:**
- **範囲**: -100～100（整数）
- **正の値**: 正転（時計回り）
- **負の値**: 逆転（反時計回り）
- **0**: 停止位置（1500μsパルス）
- **絶対値**:type": "servo", "command": "rotate", "servo_index": 0, "speed": 70, "duration_ms": 2000},
        {"wait_ms": 1000}
    ]
}
```
**動作**: サーボ #0 を速度70%で2秒間回転後、自動停止して1秒待機

#### 例2: 正転・逆転サイクル

```json
{
    "name": "正転・逆転サイクル",
    "repeat": 3,
    "steps": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 80, "duration_ms": 1500},
        {"wait_ms": 500},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": -80, "duration_ms": 1500},
        {"wait_ms": 500}
    ]
}
```
**動作**: 1.5秒正転 → 0.5秒停止 → 1.5秒逆転 → 0.5秒停止 を3回繰り返し

#### 例3: 複数サーボ同時制御

```json
{
    "name": "複数サーボ連動",
    "repeat": 1,
    "steps": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 60},
        {"type": "servo", "command": "rotate", "servo_index": 1, "speed": -60},
        {"type": "servo", "command": "rotate", "servo_index": 2, "speed": 40},
        {"wait_ms": 3000},
        {"type": "servo", "command": "stop_all"}
    ]
}
```
**動作**: 3つのサーボを異なる速度・方向で同時起動 → 3秒後に全停止

#### 例4: 加減速パターン（速度変化）

```json
{
    "name": "加減速パターン",
    "repeat": 1,
    "steps": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 30, "duration_ms": 500},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 60, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 100, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 60, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 30, "duration_ms": 500},
        {"type": "servo", "command": "stop", "servo_index": 0}
    ]
}
```
**動作**: 低速 → 中速 → 高速 → 中速 → 低速 → 停止（滑らかな加減速）

#### 例5: 停止フラグ活用（長時間回転）

```json
{
    "name": "長時間回転テスト",
    "repeat": 1,
    "steps": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 50, "duration_ms": 30000},
        {"type": "servo", "command": "stop", "servo_index": 00, "speed": 60, "duration_ms": 1000}},
        {"servo_rotate": {"servo_index": 0, "speed": 100, "duration_ms": 1000}},
        {"servo_rotate": {"servo_index": 0, "speed": 60, "duration_ms": 1000}},
        {"servo_rotate": {"servo_index": 0, "speed": 30, "duration_ms": 500}},
        {"servo_stop": {"servo_index": 0}}
    ]
}
```
**動作**: 低速 → 中速 → 高速 → 中速 → 低速 → 停止（滑らかな加減速）

#### 例5: 停止フラグ活用（長時間回転）

```json
{
    "name": "長時間回転テスト",
    "repeat": 1,
    "steps": [
        {"servo_rotate": {"servo_index": 0, "speed": 50, "duration_ms": 30000}},
        {"servo_stop": {"servo_index": 0}}
    ]
}
```
**動作**: 30秒間回転（ボタン押下で即座に中断可能）

---

## 5. 動作原理（ブロッキング方式と停止フラグ）

### 5.1. PWM信号とパルス幅

サーボモーター（SG90-HV）は、50HzのPWM信号のパルス幅で制御されます：

```
パルス幅 (μs)  |  動作
---------------|------------------
   1000        |  左回転（最速）
   1500        |  停止
   2000        |  右回転（最速）
```

#### 速度パラメータとパルス幅の変換

ユーザーが指定する`speed`（-100～100）を、適切なパルス幅（1000～2000μs）に変換します：

```python
def speed_to_pulse_width(speed):
    """速度パラメータ（-100～100）をパルス幅（μs）に変換
    
    Args:
        speed: -100（最速逆転）～ 0（停止）～ 100（最速正転）
    
    Returns:
        パルス幅（μs）: 1000～2000
    """
    # speedを-100～100から0～100に正規化
    normalized = (speed + 100) / 2  # 0～100
    # パルス幅に変換（1000μs～2000μs）
    pulse_width_us = 1000 + (normalized * 10)
    return int(pulse_width_us)

# 例:
# speed = -100 → 1000μs（最速逆転）
# speed = 0    → 1500μs（停止）
# speed = 50   → 1750μs（中速正転）
# speed = 100  → 2000μs（最速正転）
```

#### デューティサイクルの計算

PWMのデューティサイクル（16bit: 0～65535）に変換：

```python
def pulse_width_to_duty(pulse_width_us, frequency=50):
    """パルス幅（μs）をデューティサイクル（16bit）に変換
    
    Args:
        pulse_width_us: パルス幅（μs）
        frequency: PWM周波数（Hz）
    
    Returns:
        デューティサイクル（0～65535）
    """
    period_us = 1_000_000 / frequency  # 50Hz → 20000μs
    duty_ratio = pulse_width_us / period_us
    duty_u16 = int(duty_ratio * 65535)
    return duty_u16

# 例: 50Hz、1500μs（停止）の場合
# period = 20000μs
# duty_ratio = 1500 / 20000 = 0.075
# duty_u16 = 0.075 * 65535 ≒ 4915
```

### 5.2. ブロッキング実行（時間制御回転）

`duration_ms`が指定された場合、その時間だけ回転してから自動停止します：

```python
def rotate_timed(servo_index, speed, duration_ms, stop_flag_ref):
    """指定時間だけサーボを回転させる（ブロッキング）
    
    Args:
        servo_index: サーボインデックス（0-2）
        speed: 速度（-100～100）
        duration_ms: 回転時間（ms）
        stop_flag_ref: 停止フラグ（リスト参照）
    """
    if servo_index not in available_servos:
        print(f"Servo #{servo_index} is not available (skipped)")
        return False
    
    # 速度設定
    set_speed(servo_index, speed)
    
    # 指定時間待機（停止フラグ監視）
    CHECK_INTERVAL_MS = 50
    start_time = time.ticks_ms()
    
    while time.ticks_diff(time.ticks_ms(), start_time) < duration_ms:
        if stop_flag_ref[0]:
            print(f"Servo #{servo_index} rotation interrupted by stop flag.")
            stop(servo_index)
            return False
        time.sleep_ms(CHECK_INTERVAL_MS)
    
    # 自動停止
    stop(servo_index)
    return True
```

### 5.3. 停止フラグによる割り込み

#### 停止フラグの仕組み
- `stop_flag_ref[0]`は共有されるフラグ（リスト参照）
- 時間制御回転中、定期的にフラグをチェック
- フラグが`True`になると、サーボを停止して処理を中断

#### 応答時間
停止フラグによる中断は**協調的キャンセル**のため、最大50ms程度の遅延が発生します。

この値は`config.py`で調整可能です：
```python
SERVO_ROTATION_CHECK_INTERVAL_MS = 50  # 小さくすると応答性向上、CPU負荷増加
```

---

## 6. エラーハンドリング仕様

サーボモーター制御は、既存のPWM LEDやNeoPixelと同じ**グレースフルデグラデーション**方式を採用します。

### 6.1. 初期化時のエラー処理

```python
# servo_controller.py

servos = []  # PWMインスタンスのリスト
available_servos = set()  # 利用可能なサーボインデックス

def is_servo_available():
    """サーボが少なくとも1つ利用可能かどうかを返す"""
    return len(available_servos) > 0

def init_servos():
    """サーボモーターを初期化（失敗したピンはスキップ）"""
    global servos, available_servos
    
    servos = [None] * len(config.SERVO_PINS)
    available_servos = set()
    
    for i, pin_num in enumerate(config.SERVO_PINS):
        try:
            pin = Pin(pin_num)
            pwm = PWM(pin)
            pwm.freq(config.SERVO_FREQUENCY)  # 50Hz
            
            # 初期状態: 停止位置（1500μs）
            stop_duty = pulse_width_to_duty(1500)
            pwm.duty_u16(stop_duty)
            
            servos[i] = pwm
            available_servos.add(i)
            print(f"Servo #{i} on GP{pin_num} initialized (stopped at 1500μs).")
        except OSError as e:
            print(f"Warning: Servo #{i} on GP{pin_num} initialization failed: {e}")
            servos[i] = None
        except Exception as e:
            print(f"Error: Servo #{i} initialization error: {e}")
            servos[i] = None
    
    if len(available_servos) == 0:
        print("Warning: No servos were successfully initialized. Servo functionality will be disabled.")
    else:
        print(f"Servo: {len(available_servos)}/{len(config.SERVO_PINS)} servos available")
```

### 6.2. ランタイムエラー処理

各関数で利用可否をチェックし、利用不可の場合はスキップします：

```python
def set_speed(servo_index, speed):
    """指定されたサーボの速度を設定
    
    Args:
        servo_index: サーボインデックス（0-2）
        speed: 速度（-100～100）
    
    Returns:
        bool: 成功時True、失敗時False
    """
    if servo_index not in available_servos:
        print(f"Servo #{servo_index} is not available (skipped)")
        return False
    
    # 速度範囲チェック
    if not -100 <= speed <= 100:
        print(f"Warning: Speed {speed} out of range (-100～100), clamping.")
        speed = max(-100, min(100, speed))
    
    try:
        pulse_width_us = speed_to_pulse_width(speed)
        duty = pulse_width_to_duty(pulse_width_us)
        servos[servo_index].duty_u16(duty)
        print(f"Servo #{servo_index}: speed={speed}, pulse={pulse_width_us}μs, duty={duty}")
        return True
    except OSError as e:
        print(f"[Hardware Error] Servo #{servo_index} speed set failed: {e}")
        return False
    except Exception as e:
        print(f"[Error] Servo #{servo_index} error: {e}")
        return False

def stop(servo_index):
    """指定されたサーボを停止（1500μs）"""
    return set_speed(servo_index, 0)

def stop_all():
    """すべてのサーボを停止"""
    for i in available_servos:
        stop(i)
```

###is_dict_format:
    cmd_type = cmd.get("type")
    
    if cmd_type == 'servo':
        if not servo_controller.is_servo_available():
            print("サーボ制御スキップ（モジュール未初期化）")
            continue
        
        command = cmd.get("command")
        servo_index = cmd.get("servo_index", 0)
        
        if command == "rotate":
            speed = cmd.get("speed", 0)
            duration_ms = cmd.get("duration_ms", 0)
            
            if duration_ms > 0:
                servo_controller.rotate_timed(servo_index, speed, duration_ms, stop_flag_ref)
            else:
                servo_controller.set_speed(servo_index, speed)
        
        elif command == "stop":
            servo_controller.stop(servo_index)
        
        elif command == "stop_all":
            servo_controller.stop_all()
        
        else:
            print(f"[Warning] Unknown servo command: {command}servo_index, speed, duration_ms, stop_flag_ref)
        else:
            servo_controller.set_speed(servo_index, speed)
    else:
        print(f"Servo: サーボ機能が利用できません（スキップ）")
```

---

## 7. ハードウェア接続と注意事項

### 7.1. 配線図

```
SG90-HVサーボモーター（3芯）
┌──────────────┐
│ 茶: GND      │ ──→ Pico GND
│ 赤: VCC (5V) │ ──→ 外部5V電源
│ 橙: Signal   │ ──→ Pico GPIOピン（GP5/6/7）
└──────────────┘
```

### 7.2. 重要な注意事項

#### ⚠️ 電源について（重要）

**外部5V電源が必須です**

1. **Picoの5V出力は絶対に使用しない**: 
   - サーボモーターは起動時に大電流（1個で最大1A以上）を消費
   - Picoの電源供給能力（VBUS経由で最大500mA程度）を大幅に超える
   - 電圧降下によりPicoが再起動するリスクが非常に高い

2. **外部5V電源の推奨容量**:
   - **1個使用時**: 5V 1A以上のACアダプタまたはモバイルバッテリー
   - **2-3個使用時**: 5V 2A以上（推奨: 2.4A以上のUSB充電器またはモバイルバッテリー）
   - 起動時瞬間電流を考慮し、余裕を持った容量を選択

3. **GNDの共通化（必須）**: 
   - Picoと外部5V電源のGNDは必ず接続（共通化）してください
   - GNDが共通化されていないとPWM信号が正しく伝わりません

#### 配線例
```
外部5V電源
  ├─ (+) ──→ サーボ赤線（VCC）
  └─ (-) ──→ サーボ茶線（GND）+ Pico GND（共通化）

Pico
  ├─ GP5 ──→ サーボ #0 橙線（Signal）
  ├─ GP6 ──→ サーボ #1 橙線（Signal）
  ├─ GP7 ──→ サーボ #2 橙線（Signal）
  └─ GND ──→ 外部5V電源のGND（共通化）
```

### 7.3. トラブルシューティング

| 症状 | 原因 | 対策 |
|------|------|------|
| サーボが動かない | 電源不足、配線ミス | 外部5V電源を使用、GND共通化を確認 |
| Picoが再起動する | サーボ起動時の電流でPicoの電圧降下 | サーボ電源をPicoと分離 |
| 速度が不安定 | PWM周波数ミス、信号線のノイズ | 50Hz設定を確認、信号線を短く |
| 停止位置がずれる | サーボの個体差 | 1500μs基準を微調整（1480～1520μs） |

### 7.4. テスト手順

1. **単体テスト**: まず1個のサーボで動作確認
2. **電源確認**: 外部5V電源の電圧を測定（4.8V～5.2V）
3. **信号確認**: オシロスコープでPWM信号を確認（50Hz、パルス幅1000～2000μs）
4. **負荷テスト**: 複数サーボ同時起動時の電流測定

---

## 8. 制御パラメータ詳細（config.py）

### 8.1. 追加する設定項目

```python
# config.py に追加

# サーボモーター設定
# ----------------------------------------------------------------
# 連続回転サーボモーター（SG90-HV）のGPIOピン
SERVO_PINS = [5, 6, 7]

# サーボPWM周波数 (Hz) - サーボの標準仕様
SERVO_FREQUENCY = 50

# パルス幅範囲（μs）
SERVO_MIN_PULSE_US = 1000  # 最速逆転
SERVO_MAX_PULSE_US = 2000  # 最速正転

# 停止位置のパルス幅（μs）- サーボごとに個体差調整可能
# 配列形式: 各サーボごとに個別設定（推奨）
SERVO_STOP_PULSE_WIDTH_US = [1500, 1500, 1500]  # [Servo#0, #1, #2]
# 単一値形式: 全サーボ共通の場合
# SERVO_STOP_PULSE_WIDTH_US = 1500
# 個体差がある場合の調整例:
# SERVO_STOP_PULSE_WIDTH_US = [1480, 1500, 1520]

# デフォルト速度（-100～100）
SERVO_DEFAULT_SPEED = 0  # 初期状態は停止

# 時間制御回転のチェック間隔（ms）
SERVO_ROTATION_CHECK_INTERVAL_MS = 50
```

### 8.2. パラメータのカスタマイズ

#### サーボの個体差に対応
一部のサーボは、1500μsで完全に停止しない場合があります。その場合は個別に微調整が必要です：

```python
# 例: サーボ#0が1480μs、サーボ#2が1520μsで停止する場合
SERVO_STOP_PULSE_WIDTH_US = [1480, 1500, 1520]

# 全て同じ値の場合（単一値も可）
SERVO_STOP_PULSE_WIDTH_US = 1500
```

**調整手順:**
1. サーボを接続して起動（初期値1500μs）
2. サーボが微妙に回転している場合、値を±20μs程度調整
3. 完全に停止する値を見つけて`config.py`に設定

#### 応答性を向上
チェック間隔を短くすると、停止フラグへの応答が速くなります（CPU負荷は増加）：

```python
SERVO_ROTATION_CHECK_INTERVAL_MS = 20  # 50ms → 20ms
```

---

## 9. 実装フェーズ

サーボモーター制御の実装は、以下の5つのフェーズに分けて段階的に進めます。

### Phase 1: 設定とコントローラー基礎
**目的**: サーボモーター制御の基盤を構築
**作業内容**:
1. `config.py`にサーボモーター設定を追加
2. `servo_controller.py`を新規作成
   - `init_servos()`: 初期化
   - `is_servo_available()`: 利用可否チェック
   - `speed_to_pulse_width()`: 速度→パルス幅変換
   - `pulse_width_to_duty()`: パルス幅→デューティサイクル変換
   - `set_speed()`: 速度設定
   - `stop()`: 停止
   - `stop_all()`: 全停止

**検証**: `servo_controller.py`を単体で実行し、基本動作を確認

```python
# テストコード例
import servo_controller
import time

servo_controller.init_servos()

if servo_controller.is_servo_available():
    # 正転テスト
    servo_controller.set_speed(0, 50)
    time.sleep(2)
    
    # 停止テスト
    servo_controller.stop(0)
    time.sleep(1)
    
    # 逆転テスト
    servo_controller.set_speed(0, -50)
    time.sleep(2)
    
    # 全停止テスト
    servo_controller.stop_all()
```

---

### Phase 2: 時間制御回転と停止フラグ対応
**目的**: ブロッキング実行と停止フラグ対応を実装
**作業内容**:
1. `servo_controller.py`に機能追加
   - `rotate_timed()`: 時間指定回転（ブロッキング、stop_flag対応）

**検証**: 停止フラグによる中断動作を確認

```python
# テストコード例
stop_flag = [False]

def test_timed_rotation():
    servo_controller.init_servos()
    
    # 5秒間回転（途中で停止フラグを立てて中断テスト）
    import _thread
    
    def set_flag_after_delay():
        time.sleep(2)
        stop_flag[0] = True
        print("Stop flag set!")
    
    _thread.start_new_thread(set_flag_after_delay, ())
    servo_controller.rotate_timed(0, 70, 5000, stop_flag)
    print("Rotation completed or interrupted")
```

---

### Phase 3: システム統合
**目的**: 既存システムにサーボモーター制御を統合
**作業内容**:
1. `system_init.py`を更新
   - `servo_controller`のインポート追加
   - 初期化処理追加
   - 起動時のステータス表示
2. `hardware_init.py`を更新（必要に応じて）
   - サーボ初期化を追加

**検証**: システム起動時にサーボが正しく初期化されることを確認

---

### Phase 4: エフェクトコマンド処理
**目的**: scenarios.jsonからサーボ制御を実行できるようにする
**作業内容**:
1. `effects.py`の`execute_command()`に処理追加
   - `servo_rotate`: 回転制御
   - `servo_stop`: 単体停止
   - `servo_all_stop`: 全停止

**検証**: テストシナリオで動作確認

```json
{
    "test_servo_basic": [
        {"servo_rotate": {"servo_index": 0, "speed": 60, "duration_ms": 2000}},
        {"wait_ms": 1000},
        {"servo_rotate": {"servo_index": 0, "speed": -60, "duration_ms": 2000}}
    ]
}
```

---

### Phase 5: テストシナリオとドキュメント
**目的**: 動作検証とユーザー向けドキュメント整備
**作業内容**:
1. `scenarios.json`にテストシナリオを追加
   - 基本動作テスト
   - 複数サーボテスト
   - 複合演出テスト
2. `readmetype": "servo", "command": "rotate", "servo_index": 0, "speed": 70, "duration_ms": 2000},
        {"wait_ms": 1000},
        {"type": "servo", "command": "stop", "servo_index": 0},
        {"wait_ms": 500}
    ]
}
```

### 正転・逆転テスト
```json
{
    "test_servo_bidirectional": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 80, "duration_ms": 1500},
        {"wait_ms": 500},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": -80, "duration_ms": 1500},
        {"wait_ms": 500}
    ]
}
```

### 複数サーボ同時テスト
```json
{
    "test_servo_multi": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 60},
        {"type": "servo", "command": "rotate", "servo_index": 1, "speed": -60},
        {"type": "servo", "command": "rotate", "servo_index": 2, "speed": 40},
        {"wait_ms": 3000},
        {"type": "servo", "command": "stop_all"}
    ]
}
```

### 加減速テスト
```json
{
    "test_servo_acceleration": [
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 20, "duration_ms": 500},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 50, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 100, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 50, "duration_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 20, "duration_ms": 500},
        {"type": "servo", "command": "stop", "servo_index": 0}
    ]
}
```

### 複合演出テスト（LED + 音声 + サーボ）
```json
{
    "test_servo_combined": [
        ["sound", 1, 1],
        {"led_fade_in": {"led_index": 0, "duration_ms": 500, "max_brightness": 80}},
        {"type": "servo", "command": "rotate", "servo_index": 0, "speed": 70, "duration_ms": 3000},
        {"wait_ms": 1000},
        {"type": "servo", "command": "rotate", "servo_index": 1, "speed": -50, "duration_ms": 2000},
        {"led_fade_out": {"led_index": 0, "duration_ms": 500}},
        {"type": "servo", "command": "stop_all"o_index": 0, "speed": 100, "duration_ms": 1000}},
        {"servo_rotate": {"servo_index": 0, "speed": 50, "duration_ms": 1000}},
        {"servo_rotate": {"servo_index": 0, "speed": 20, "duration_ms": 500}},
        {"servo_stop": {"servo_index": 0}}
    ]
}
```

### 複合演出テスト（LED + 音声 + サーボ）
```json
{
    "test_servo_combined": [
        ["sound", 1, 1],
        {"led_fade_in": {"led_index": 0, "duration_ms": 500, "max_brightness": 80}},
        {"servo_rotate": {"servo_index": 0, "speed": 70, "duration_ms": 3000}},
        {"wait_ms": 1000},
        {"servo_rotate": {"servo_index": 1, "speed": -50, "duration_ms": 2000}},
        {"led_fade_out": {"led_index": 0, "duration_ms": 500}},
        {"servo_all_stop": true}
    ]
}
```

---

## 11. まとめ

本仕様書により、Raspberry Pi Pico 2Wで360°連続回転サーボモーター（SG90-HV）を制御する機能が追加されます。

### 主な利点
- **JSONベースの簡単設定**: プログラミング不要で演出作成
- **複合演出が可能**: LED、音声、モーターとの同時制御
- **安全な停止機能**: 停止フラグによる即座の中断
- **柔軟な制御**: 速度・時間・方向を自由に設定

### 次のステップ
1. Phase 1から順番に実装
2. 各フェーズで動作検証
3. テストシナリオで総合テスト
4. ドキュメント更新

---

**作成日**: 2025年12月16日  
**対象デバイス**: Raspberry Pi Pico 2W  
**対象サーボ**: SG90-HV（360°連続回転サーボ）  
**バージョン**: 1.0
